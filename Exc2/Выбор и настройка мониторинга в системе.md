**Планирование мониторинга в системе «Александрит»**

## 1. Мотивация

Добавление мониторинга в систему «Александрит» критически важно, поскольку:
- **Поможет выявить узкие места** в обработке заказов, которые приводят к задержкам.
- **Позволит оперативно реагировать на сбои** в CRM, MES и API, уменьшая влияние на клиентов.
- **Обеспечит контроль над производительностью** системы, особенно при росте нагрузки.
- **Снизит время диагностики проблем** за счёт централизованного сбора метрик.
- **Улучшит SLA** за счёт раннего обнаружения проблем.

## 2. Выбор подхода к мониторингу

Для разных частей системы выберем наиболее подходящий подход:
- **Онлайн-магазин (Vue, Spring Boot)** – модель RED (Rate, Errors, Duration), так как важны показатели пользовательского взаимодействия.
- **MES API (C#)** – модель USE (Utilization, Saturation, Errors), так как важна загрузка серверов и балансировка нагрузки.
- **CRM API (Spring Boot)** – "Четыре золотых сигнала" (Latency, Traffic, Errors, Saturation), так как важно контролировать ошибки и пропускную способность.
- **RabbitMQ** – "Четыре золотых сигнала", так как важны задержки и стабильность сообщений в очереди.
- **Базы данных (PostgreSQL)** – модель USE, так как критична загрузка и пропускная способность базы.

## 3. Метрики для мониторинга

### Общие метрики для всех API (Shop API, CRM API, MES API)
1. **Количество запросов в секунду (RPS)** (RED)
   - **Зачем:** Позволяет выявить аномалии в нагрузке.
   - **Ярлыки:** url запроса, метод запроса, код ответа запроса.

2. **Ошибки (Error Rate)** (RED)
   - **Зачем:** Помогает выявить падение сервисов.
   - **Ярлыки:** url запроса, метод запроса, код ответа запроса.

3. **Время ответа API (Latency)** (Четыре золотых сигнала)
   - **Зачем:** Позволяет следить за быстродействием API.
   - **Ярлыки:** url запроса, метод запроса, код ответа запроса.

### RabbitMQ
4. **Очереди сообщений (Queue Length)** (Четыре золотых сигнала)
   - **Зачем:** Позволяет избежать перегрузки.
   - **Ярлыки:** Название очереди.

5. **Время обработки сообщений (Processing Time)** (Четыре золотых сигнала)
   - **Зачем:** Контролирует задержки в обмене сообщениями.
   - **Ярлыки:** Название очереди.

### Базы данных (Shop DB, MES DB)
6. **Загрузка процессора (CPU Utilization)** (USE)
   - **Зачем:** Контроль загрузки серверов БД.
   - **Ярлыки:** Сервер.

7. **Количество медленных запросов (Slow Queries)** (USE)
   - **Зачем:** Выявление проблемных SQL-запросов.
   - **Ярлыки:** Тип запроса.

### MES (Frontend, React)
8. **Время загрузки страницы заказов**
   - **Зачем:** Оптимизация пользовательского опыта операторов.
   - **Ярлыки:** Страница сайта.

9. **Количество активных пользователей (Active Users)**
   - **Зачем:** Контроль нагрузки и поведения пользователей.
   - **Ярлыки:** Пользователи по ролям.

### Дополнительные метрики
10. **Очередь необработанных заказов**
   - **Зачем:** Отслеживание задержек в заказах.
   - **Ярлыки:** Статус.

11. **Количество зависших заказов (Pending Orders > X дней)**
   - **Зачем:** Помогает анализировать проблемы с выполнением заказов.
   - **Ярлыки:** Обработка заказов (B2B/B2C).

## План действий
### 1. Развертывание инфраструктуры для мониторинга
- Создать инстанс time-series базы данных (OpenTelemetry) для хранения метрик.
- Развернуть систему логирования и трассировки (ELK stack, Jaeger).
- Настроить алертинг с уведомлениями (Alertmanager, Telegram/Slack интеграция).

### 2. Сбор метрик
- Интегрировать OpenTelemetry SDK для сбора данных с API, баз данных и очередей сообщений.
- Добавить метрики в код API (например, OpenTelemetry SDK в Java и C#).
- Включить трассировку запросов для анализа задержек и узких мест.

### 3. Визуализация и анализ
- Использвать визуаизацию Jaeger и ELK для разных частей системы.
- Разработать отчёты по SLA и производительности сервисов.

### 4. Настройка алертов и автоматизации
- Определить критические пороги метрик и настроить автоматические уведомления.
- Внедрить механизмы авто-скейлинга и балансировки нагрузки.
