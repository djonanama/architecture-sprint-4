# Архитектурное решение по кешированию

## 1. Мотивация

Компания «Александрит» столкнулась с проблемами в системе управления производством (MES), связанными с увеличением времени загрузки страницы операторов и ростом количества просроченных заказов.

### Основные проблемы:
- **Медленная загрузка дашборда операторов в MES**: Первичная страница с заказами загружается слишком долго, несмотря на введённую пагинацию и фильтрацию.
- **Низкая скорость обработки заказов**: API пользователей жалуются на задержки, клиенты онлайн-магазина также недовольны длительным ожиданием выполнения заказов.
- **Рост нагрузки на базу данных**: С увеличением количества заказов увеличивается количество запросов к базе данных, что создаёт узкие места в производительности.

### Цели кеширования:
- **Снизить время загрузки заказов в MES**.
- **Уменьшить количество запросов к базе данных**.
- **Снизить нагрузку на API MES и CRM**.
- **Обеспечить быструю актуализацию данных**.

## 2. Предлагаемое решение

### 2.1. Выбор типа кеширования

Для решения проблем с производительностью предложено внедрить **серверное кеширование** с клиентским дополнением. Основное кеширование будет на уровне API MES, так как это снизит нагрузку на базу данных и ускорит выдачу данных. Клиентское кеширование (например, в браузере) также может использоваться для минимизации повторных запросов операторов.

### 2.2. Паттерн кеширования

Выбранный паттерн: **Cache-Aside** (Кеширование по требованию)

#### Почему Cache-Aside?
- **Гибкость**: Данные загружаются в кеш только при необходимости.
- **Обновляемость**: При изменении заказа кеш можно легко инвалидировать, предотвращая устаревшие данные.
- **Снижение нагрузки**: API сначала проверяет кеш, а затем базу данных.

#### Почему не Write-Through и Refresh-Ahead?
- **Write-Through** записывает данные в кеш при каждом изменении в БД, что приведёт к излишним операциям записи.
- **Refresh-Ahead** обновляет кеш заранее, но в MES данные изменяются неравномерно, что может привести к частым ненужным обновлениям.

### 2.3. Где использовать кеширование

- **Кеширование списка заказов** в MES API (Redis): операторы часто запрашивают список актуальных заказов.
- **Кеширование расчёта стоимости заказа** (Redis/Memcached): MES запрашивает расчёт стоимости через API CRM.
- **Кеширование статусов заказов** (Redis с TTL): для ускорения обновления статусов без лишней нагрузки на БД.

## 3. Диаграмма последовательности действий

[Диаграмма заказов](https://editor.plantuml.com/uml/dLJ1Ji904BttApRS_G4F1X58F1YDVi4AJIH186sz2mJHQ2Gn9dB2-0UbeK2em2_C_95ljnJQIeX8KdQxCs_Usva7MTkHbdDtMpLaoQbRuhnXMX8Reu7ZIgdIa3L7PCuALw9erMkEMIjdXBH5iV0xuVZYLCUm9eENPhbYYnDPkZ5rWjubK_BIaTVI3kFvd654EiJ14SWE1NsGIqk-fmKt1JTfILDypyWLD4446wmByenYGK6W0PXFd0JSvYxvDASf-JkHm2YeLgV0Yemyyh7gx3ao0u2xU7gfIfx0wlCZ-OQiEeBUaJkdEJ-34-TDRl5B8alWevasQjz0Do4FT2u_0UzpQyEoe5bQhrcrpHWJTvH41Khph2wMp-tHHeNBv_ulBiORDVGBf1rLGCdSEe-ORXWj6eWU_xxyeGqY5w70W5i833N_UCrFeqtxjfYkZshVEdaZ67LSZBCDtaJNt8JrudrMpX50xwvbnCSqe26IbFs2Fr6dMjq7n0ljgcx83zgog-O2kgI5UWlubRlSJZHQ_MP680gDFmPytQlK3RXdP34c_7Vy0000)


## 4. Стратегия инвалидации кеша

Выбранный подход: **Инвалидация по ключу с временной стратегией**

- **По ключу**: При изменении статуса заказа или его обновлении соответствующий кеш автоматически удаляется.
- **Временная стратегия (TTL)**: Если заказ не меняется, он удаляется из кеша через определённый промежуток времени (например, 5 минут).

Почему не использовать только временную стратегию?
- Долгое ожидание обновления кеша.
- Возможность отображения устаревших данных операторам.

## 5. Сравнительный анализ стратегий

| Стратегия                 | Достоинства                                                 | Недостатки                             |
|---------------------------|-------------------------------------------------------------|----------------------------------------|
| Инвалидация по ключу      | Мгновенное обновление данных, нет устаревшей информации     | Требует отслеживания изменений         |
| Временная стратегия (TTL) | Простота реализации, меньше операций записи                 | Возможность показа устаревших данных   |
| Комбинированный подход    | Оптимальное сочетание актуальности и производительности     | Сложнее в реализации                   |
